name: Lunatik Build CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    strategy:
      matrix:
        kernel-version: [5.15, 6.1, 6.6, 6.11]
      fail-fast: false  # Don't stop all matrix jobs on one failure
    runs-on: ubuntu-24.04  # Explicitly noble
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git build-essential bc bison flex \
          libssl-dev dwarves clang llvm \
          libelf-dev pkg-config libpcap-dev \
          libncurses-dev m4
    
    - name: Download kernel ${{ matrix.kernel-version }}
      run: |
        wget https://cdn.kernel.org/pub/linux/kernel/v${{ matrix.kernel-version[0] }}.x/linux-${{ matrix.kernel-version }}.tar.xz
        tar xf linux-${{ matrix.kernel-version }}.tar.xz
    
    - name: Configure kernel
      run: |
        cd linux-${{ matrix.kernel-version }}
        # Use default config for clean CI builds
        make defconfig
        make -j$(nproc) modules_prepare
    
    - name: Build Lunatik
      run: |
        export KERNEL_DIR=$(pwd)/linux-${{ matrix.kernel-version }}
        make -C "$KERNEL_DIR" M=$(pwd) modules
    
    - name: Verify modules
      run: |
        ls -la *.ko
        modinfo lunatik.ko || true
    
    - name: Upload artifacts on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: lunatik-${{ matrix.kernel-version }}
        path: |
          *.ko
          *.o
          linux-${{ matrix.kernel-version }}/.config
