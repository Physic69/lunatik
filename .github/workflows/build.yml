name: Lunatik Build CI
on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:
  build:
    strategy:
      matrix:
        kernel-version: [5.15, 6.1]
      fail-fast: false
    runs-on: ubuntu-24.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install deps
      run: |
        sudo apt-get update -qq
        sudo apt-get install -yq \
          build-essential bc bison flex libssl-dev \
          dwarves libelf-dev libncurses-dev \
          clang llvm pkg-config libpcap-dev \
          lua5.4-dev m4
    
    - name: Setup kernel ${{ matrix.kernel-version }}
      run: |
        wget -q https://cdn.kernel.org/pub/linux/kernel/v${{ matrix.kernel-version[0] }}.x/linux-${{ matrix.kernel-version }}.tar.xz
        tar xf linux-${{ matrix.kernel-version }}.tar.xz
        cd linux-${{ matrix.kernel-version }}
        make defconfig
        make modules_prepare -j$(nproc)
    
    - name: Build Lunatik
      run: |
        make -C linux-${{ matrix.kernel-version }} M=$(pwd) modules
    
    - name: Verify
      run: ls -la *.ko
